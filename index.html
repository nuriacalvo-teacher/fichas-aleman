<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fichas de AlemÃ¡n con Audio â€” Adivina y Voltea</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --card:#111827ee; /* gray-900 */
      --cardEdge:#1f2937; /* gray-800 */
      --accent:#22d3ee; /* cyan-400 */
      --ok:#22c55e; /* green-500 */
      --bad:#ef4444; /* red-500 */
      --muted:#94a3b8; /* slate-400 */
      --text:#e5e7eb; /* gray-200 */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      background:radial-gradient(1400px 900px at 85% -15%,#1e293b 0%,#0f172a 70%);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:32px;
    }
    .app{
      width:min(980px,100%);
      display:flex;
      flex-direction:column;
      flex-grow:1;
    }
    header{
      display:flex;
      flex-direction:column;
      gap:16px;
      align-items:center;
      margin-top:48px;
    }
    h1{
      font-weight:800;
      font-size:clamp(30px,4.5vw,44px);
      letter-spacing:.4px;
      margin:0;
    }
    .hint{
      color:var(--muted);
      font-size:1.05rem;
      text-align:center;
    }
    .studentInfo{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      width:100%;
      justify-content:center;
    }
    .studentInfo input{
      flex:1;
      background:#0b1220;
      border:1px solid #1f2937;
      color:var(--text);
      padding:12px 16px;
      border-radius:12px;
      font-size:18px;
    }
    main{
      flex-grow:1;
      display:flex;
      flex-direction:column;
      justify-content:center;
    }
    .board{
      display:grid;
      grid-template-columns:1.2fr .8fr;
      gap:24px;
    }
    @media (max-width:850px){
      .board{grid-template-columns:1fr;}
    }
    .cardWrap{
      perspective:1200px;
      transition:transform .3s ease;
    }
    .cardWrap:hover{
      transform:scale(1.02);
    }
    .card{
      position:relative;
      width:100%;
      min-height:100%;
      background:transparent;
      border-radius:20px;
      margin-top:100px;
    }
    .inner{
      position:relative;
      width:100%;
      height:100%;
      transform-style:preserve-3d;
      transition:transform .6s cubic-bezier(.2,.8,.2,1);
    }
    .card.flipped .inner{
      transform:rotateY(180deg);
    }
    .face{
      position:absolute;
      inset:0;
      background:linear-gradient(180deg,rgba(17,24,39,.98),rgba(17,24,39,.88));
      border:1px solid var(--cardEdge);
      border-radius:20px;
      box-shadow:0 12px 40px rgba(0,0,0,.3), 0 0 10px rgba(34,211,238,.1);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:20px;
      backface-visibility:hidden;
      padding:32px;
    }
    .back{
      transform:rotateY(180deg);
    }
    .word{
      font-size:clamp(22px,4vw,32px);
      font-weight:400;
      line-height:1.05;
      text-align:center;
    }
    .meaning{
      font-size:clamp(22px,4vw,32px);
      opacity:.9;
      text-align:center;
    }
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      margin-top:18px;
    }
    button, .ghostBtn{
      appearance:none;
      border:1px solid transparent;
      background:var(--cardEdge);
      color:var(--text);
      padding:16px 18px;
      border-radius:16px;
      font-size:19px;
      cursor:pointer;
      transition:.2s ease;
    }
    button:hover, .ghostBtn:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 20px rgba(0,0,0,.3);
    }
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }
    .primary{
      background:linear-gradient(135deg,#1e40af,#38bdf8);
      border-color:#38bdf888;
    }
    .success{
      background:linear-gradient(135deg,#15803d,#4ade80);
      border-color:#4ade8088;
    }
    .danger{
      background:linear-gradient(135deg,#b91c1c,#f87171);
      border-color:#f8717188;
    }
    .voice{
      background:linear-gradient(135deg,#6d28d9,#a78bfa);
      border-color:#a78bfa88;
    }
    .voice.listening{
      background:linear-gradient(135deg,#a855f7,#d8b4fe);
      animation:pulse 1.5s infinite;
    }
    @keyframes pulse{
      0%{transform:scale(1);}
      50%{transform:scale(1.05);}
      100%{transform:scale(1);}
    }
    .panel{
      background:linear-gradient(180deg,rgba(17,24,39,.82),rgba(2,6,23,.62));
      border:1px solid var(--cardEdge);
      border-radius:18px;
      padding:22px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .guessRow{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
    }
    input[type="text"]{
      flex:1;
      background:#0b1220;
      border:1px solid #1f2937;
      color:var(--text);
      padding:16px 18px;
      border-radius:16px;
      font-size:21px;
    }
    .status{
      min-height:28px;
      font-weight:600;
      font-size:19px;
    }
    .status.ok{
      color:var(--ok);
    }
    .status.bad{
      color:var(--bad);
    }
    .tags{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .tag{
      fontwindows-1252
      font-size:14px;
      color:var(--muted);
      border:1px dashed #334155;
      padding:6px 12px;
      border-radius:999px;
    }
    .row{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
    }
    .spacer{
      flex:1;
    }
    .keyHelp{
      font-size:14px;
      color:var(--muted);
    }
    .muted{
      color:var(--muted);
    }
    .counter{
      font-variant-numeric:tabular-nums;
    }
    footer{
      margin-top:24px;
      text-align:center;
      color:var(--muted);
      font-size:1.05rem;
    }
    .leaderboard{
      background:linear-gradient(180deg,rgba(17,24,39,.98),rgba(17,24,39,.88));
      border:1px solid var(--cardEdge);
      border-radius:18px;
      padding:22px;
      margin-top:24px;
      width:100%;
      max-height:400px;
      overflow-y:auto;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:16px;
    }
    th, td{
      padding:12px;
      text-align:left;
      border-bottom:1px solid var(--cardEdge);
    }
    th{
      background:var(--cardEdge);
      font-weight:600;
    }
    tr:last-child td{
      border-bottom:none;
    }
    .leaderboard button{
      margin-top:16px;
      width:100%;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Fichas de AlemÃ¡n con Audio</h1>
      <div class="hint">Espacio: â–¶ï¸Ž Audio Â· Enter: Comprobar Â· N: Siguiente Â· F: Voltear Â· V: Voz</div>
      <div class="studentInfo">
        <input id="studentName" type="text" placeholder="Nombre..." autocomplete="off" />
        <input id="studentSurname" type="text" placeholder="Apellido..." autocomplete="off" />
      </div>
    </header>
    <main>
      <div class="board">
        <!-- Card -->
        <div class="cardWrap">
          <div id="card" class="card">
            <div class="inner">
              <section class="face front">
                <div id="frontContent"></div>
                <div class="tags">
                  <span class="tag">AlemÃ¡n</span>
                  <span class="tag">PronunciaciÃ³n con TTS</span>
                </div>
                <div class="controls">
                  <button class="primary" id="btnPlay">â–¶ï¸Ž Audio</button>
                  <button id="btnFlip">â†» Voltear</button>
                </div>
              </section>
              <section class="face back">
                <div id="backContent"></div>
                <div class="controls">
                  <button class="primary" id="btnPlayBack">â–¶ï¸Ž Audio</button>
                  <button id="btnFlipBack">â†º Volver</button>
                </div>
              </section>
            </div>
          </div>
        </div>
        <!-- Side panel -->
        <aside class="panel">
        <div class="row">
          <div><strong>Ronda:</strong> <span class="counter" id="round">1</span></div>
          <div><strong>Progreso:</strong> <span class="counter" id="progress">1 / 1</span></div>
          <div><strong>PuntuaciÃ³n:</strong> <span class="counter" id="score">0</span></div>
          <div class="spacer"></div>
         <div><strong>Aciertos:</strong> <span class="counter" id="hits">0</span></div>
         <div><strong>Fallos:</strong> <span class="counter" id="fails">0</span></div>
        </div>
          <div class="guessRow">
            <input id="guess" type="text" placeholder="Escribe o di el significado en espaÃ±ol o alemÃ¡nâ€¦" autocomplete="off" />
            <button class="success" id="btnCheck">Comprobar</button>
            <button class="voice" id="btnVoice">ðŸŽ¤ Voz</button>
          </div>
          <div id="status" class="status" aria-live="polite"></div>
          <div class="controls">
            <button id="btnNext">Siguiente</button>
            <button id="btnShuffle">Barajar</button>
            <button id="btnOnlyWrong" class="ghostBtn">Solo falladas: <span id="onlyWrongState">off</span></button>
            <button id="btnToggleMode">Cambiar a AlemÃ¡n a EspaÃ±ol</button>
            <button id="btnSaveResults" class="danger">Finalizar y Guardar Resultados</button>
            <button id="btnShowLeaderboard" class="primary">Ver ClasificaciÃ³n</button>
          </div>
          <details>
            <summary>Opciones de voz</summary>
            <div class="row">
              <label class="muted">Velocidad <input id="rate" type="range" min=".7" max="1.4" step=".1" value="1.1"/></label>
              <label class="muted">Tono <input id="pitch" type="range" min=".8" max="1.2" step=".1" value="1.1"/></label>
              <label class="muted">Volumen <input id="volume" type="range" min=".2" max="1" step=".1" value="1"/></label>
            </div>
          </details>
          <p class="keyHelp">Consejo: puedes responder con la palabra en alemÃ¡n o con el significado en espaÃ±ol (se aceptan sinÃ³nimos sencillos).</p>
        </aside>
      </div>
      <div id="leaderboard" class="leaderboard" style="display:none;">
        <table>
          <thead>
            <tr>
              <th>Apellido</th>
              <th>Nombre</th>
              <th>Aciertos</th>
              <th>Fallos</th>
              <th>PuntuaciÃ³n</th>
              <th>Rondas</th>
              <th>Fichas Falladas</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
        <button id="btnCopyResults">Copiar Resultados</button>
      </div>
    </main>
    <footer>Â© 2025 Nuria Calvo</footer>
  </div>
  
  <script>
    // === Banco de cartas ===
    const DECK = [
      {de:"berÃ¼hmt", es:["famoso","cÃ©lebre"]},
      {de:"Nachhaltigkeit", es:["sostenibilidad"]},
      {de:"Geige", es:["violÃ­n"]},
      {de:"Gute Laune", es:["buen humor"]},
      {de:"Abitur", es:["examen de bachillerato","selectividad"]},
      {de:"Schneiderei", es:["sastrerÃ­a","taller de costura"]},
      {de:"sogar", es:["incluso","hasta"]},
      {de:"Transparent", es:["pancarta","cartel transparente"]},
      {de:"der Stoff", es:["tela","material"]},
      {de:"stolz", es:["orgulloso"]},
      {de:"Ã¼berqueren", es:["cruzar"]},
      {de:"FrÃ¼hling", es:["primavera"]},
      {de:"flieÃŸen", es:["fluir","correr (agua)"]},
      {de:"Eisbach", es:["rÃ­o de hielo"]},
      {de:"Welle", es:["ola"]},
      {de:"Heimat", es:["hogar","patria"]},
      {de:"zufrieden", es:["contento","satisfecho"]},
      {de:"Vorbereitung", es:["preparaciÃ³n"]},
      {de:"Keller", es:["sÃ³tano"]},
      {de:"laufen", es:["correr","funcionar"]},
      {de:"leihen", es:["prestar","tomar prestado"]},
      {de:"aufpassen", es:["tener cuidado","prestar atenciÃ³n","cuidar"]},
      {de:"gesund", es:["sano","saludable"]},
      {de:"ZÃ¤hne", es:["dientes"]},
      {de:"zieht", es:["tira","jala"]},
      {de:"Fall", es:["caso","situaciÃ³n"]},
      {de:"auf keinen Fall", es:["en ningÃºn caso","de ninguna manera"]},
      {de:"Leiter", es:["escalera","director"]},
      {de:"oje", es:["Â¡vaya!","Â¡caramba!"]},
      {de:"aufgeregt", es:["nervioso","alterado","excitado"]},
      {de:"stimmen", es:["afinar","ser correcto"]},
      {de:"Erfolg", es:["Ã©xito"]},
      {de:"abstellen", es:["colocar","poner","apagar"]},
      {de:"gestresst", es:["estresado"]},
      {de:"stehen", es:["estar de pie"]},
      {de:"aufstehen", es:["levantarse"]},
      {de:"froh", es:["contento","alegre"]},
      {de:"steigen", es:["subir","ascender"]},
      {de:"Gitter", es:["reja","estructura de barrotes"]},
      {de:"bisschen", es:["un poco"]},
      {de:"festhalten", es:["sujetar","mantener firme"]},
      {de:"aufhÃ¤ngen", es:["colgar"]},
      {de:"zusehen", es:["observar","mirar atentamente"]},
      {de:"wirklich", es:["realmente","de verdad"]},
      {de:"sofort", es:["inmediatamente","de inmediato"]},
      {de:"ausfÃ¼llen", es:["rellenar (formularios)"]},
      {de:"brauchen", es:["necesitar"]},
      {de:"verbrauchen", es:["consumir","gastar"]},
      {de:"plagen", es:["molestar","perjudicar"]},
      {de:"Umwelt", es:["medio ambiente"]},
      {de:"alte Sachen", es:["cosas viejas","antiguas"]},
      {de:"tauschen", es:["intercambiar"]},
      {de:"Vero", es:["Vero"]},
      {de:"berichten", es:["informar","reportar"]},
      {de:"fleiÃŸig", es:["muy ocupado","aplicado"]},
      {de:"begeistert", es:["entusiasmado","emocionado"]},
      {de:"hinterher", es:["despuÃ©s","detrÃ¡s"]},
      {de:"verteilen", es:["distribuir"]},
      {de:"erzÃ¤hlen", es:["contar","relatar"]},
      {de:"einholen", es:["recoger","obtener","alcanzar","ponerse al dÃ­a"]},
      {de:"Kreuzung", es:["intersecciÃ³n"]},
      {de:"Ampel", es:["semÃ¡foro"]},
      {de:"kurz stehen", es:["estar de pie por un momento"]},
      {de:"bist", es:["ser","estar (tÃº eres / tÃº estÃ¡s)"]},
      {de:"wird", es:["convertirse","llegar a ser"]},
      {de:"sie rennt los", es:["empezar a correr","salir corriendo"]},
      {de:"auf dem RÃ¼cken", es:["de espaldas","sobre la espalda"]},
      {de:"so weit", es:["tan lejos","hasta ahora"]},
      {de:"umdrehen", es:["dar la vuelta","girar"]},
      {de:"plÃ¶tzlich", es:["de repente"]},
      {de:"weiterhin", es:["seguir","continuar"]},
      {de:"immer + comparativo", es:["cada vez mÃ¡s"]},
      {de:"vorbei laufen", es:["pasar por delante"]},
      {de:"werfen", es:["lanzar","arrojar"]},
      {de:"aufgeben", es:["desistir","renunciar"]},
      {de:"Ausfallerscheinung", es:["anomalÃ­a","fallo"]},
      {de:"AustauschschÃ¼lerin", es:["estudiante de intercambio"]},
      {de:"atmen", es:["respirar"]},
      {de:"erleichtert", es:["aliviado","aliviada"]},
      {de:"fragen", es:["preguntar"]},
      {de:"versprechen", es:["prometer"]},
      {de:"sprechen", es:["hablar"]},
      {de:"weil", es:["porque","ya que"]},
      {de:"Faust", es:["puÃ±o"]},
      {de:"nirgends mehr", es:["en ninguna parte mÃ¡s"]},
      {de:"aber", es:["pero","sin embargo"]},
      {de:"stehen bleiben", es:["quedarse de pie"]},
      {de:"erinnern", es:["recordar"]},
      {de:"knapp", es:["justo","apenas"]},
      {de:"hellblau", es:["azul claro"]},
      {de:"Hemd", es:["camisa"]},
      {de:"dunkelblau", es:["azul oscuro"]},
      {de:"Weste", es:["chaleco"]},
      {de:"Stiefel", es:["botas"]},
      {de:"Hose", es:["pantalones"]},
      {de:"ausziehen", es:["quitarse","desvestirse"]},
      {de:"Stift", es:["lÃ¡piz","bolÃ­grafo"]},
      {de:"Tasche", es:["bolso","tasca"]},
      {de:"Anzeige", es:["anuncio","notificaciÃ³n"]},
      {de:"vorstellen", es:["presentar","imaginar"]},
      {de:"zustellen", es:["entregar","repartir"]},
      {de:"Schulter", es:["hombro"]},
      {de:"kÃ¼mmern", es:["ocuparse","preocuparse"]},
      {de:"in der Zwischenzeit", es:["entre tanto","mientras tanto"]},
      {de:"Entscheidung", es:["decisiÃ³n"]},
      {de:"Erfahrung", es:["experiencia"]},
      {de:"wieso", es:["por quÃ©"]},
      {de:"zwar", es:["aunque"]},
      {de:"etwas", es:["algo"]},
      {de:"etwas vorhaben", es:["tener otros planes","tener algo planeado"]},
      {de:"Ã¼brigens", es:["por cierto"]},
      {de:"das Leben retten", es:["salvar la vida"]}
    ];
    const TOTAL_CARDS = DECK.length;
    let mode = 'es-to-de'; // Mueve la declaraciÃ³n de mode aquÃ­, antes de getScoringValues
    const getScoringValues = (mode) => {
    const baseCardValue = mode === 'es-to-de' ? 100 / TOTAL_CARDS : (100 / TOTAL_CARDS) * 0.75;
    return {
    CARD_VALUE: baseCardValue,
    FAIL_PENALTY: baseCardValue / 2
     };
    };
    let { CARD_VALUE, FAIL_PENALTY } = getScoringValues(mode);
// === Estado ===
    let queue = [...DECK];
    let index = 0;
    let hits = 0, fails = 0, score = 0;
    let onlyWrong = false;
    const wrongSet = new Set();
    let firstRoundCompleted = false;
    let rondas = 1;
    let firstHits = 0;
    let firstFails = 0;
    // === Utilidades ===
    const $ = sel => document.querySelector(sel);
    const frontContent = $('#frontContent');
    const backContent = $('#backContent');
    const cardEl = $('#card');
    const guessEl = $('#guess');
    const studentNameEl = $('#studentName');
    const studentSurnameEl = $('#studentSurname');
    const statusEl = $('#status');
    const progressEl = $('#progress');
    const hitsEl = $('#hits');
    const failsEl = $('#fails');
    const scoreEl = $('#score');
    const onlyWrongStateEl = $('#onlyWrongState');
    const roundEl = $('#round'); // AÃ±ade esta lÃ­nea
    const btnToggleMode = $('#btnToggleMode');
    const btnVoice = $('#btnVoice');
    const btnSaveResults = $('#btnSaveResults');
    const btnShowLeaderboard = $('#btnShowLeaderboard');
    const btnCopyResults = $('#btnCopyResults');
    const leaderboardEl = $('#leaderboard');
    const leaderboardBodyEl = $('#leaderboardBody');
    // AutocorrecciÃ³n
    function levenshtein(a, b) {
      const matrix = Array(b.length + 1).fill().map(() => Array(a.length + 1).fill(0));
      for(let i = 0; i <= a.length; i++) matrix[0][i] = i;
      for(let j = 0; j <= b.length; j++) matrix[j][0] = j;
      for(let j = 1; j <= b.length; j++) {
        for(let i = 1; i <= a.length; i++) {
          const cost = a[i - 1] === b[j - 1] ? 0 : 1;
          matrix[j][i] = Math.min(
            matrix[j - 1][i] + 1,
            matrix[j][i - 1] + 1,
            matrix[j - 1][i - 1] + cost
          );
        }
      }
      return matrix[b.length][a.length];
    }
    function autocorrect(input, item) {
      const normInput = norm(input);
      const meanings = item.es.map(norm);
      let closest = meanings[0];
      let minDistance = levenshtein(normInput, meanings[0]);
      for(const meaning of meanings) {
        const distance = levenshtein(normInput, meaning);
        if(distance < minDistance) {
          minDistance = distance;
          closest = meaning;
        }
      }
      return minDistance <= Math.ceil(meanings[0].length / 2) ? item.es[meanings.indexOf(closest)] : input;
    }
    // Speech Synthesis
    function speak(text){
      if(!('speechSynthesis' in window)){
        status('Tu navegador no soporta sÃ­ntesis de voz.', 'bad');
        return;
      }
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const voices = speechSynthesis.getVoices();
      const deVoice = voices.find(v => /de|deutsch|german/i.test(v.lang)) || voices[0];
      u.lang = deVoice ? deVoice.lang : 'de-DE';
      u.voice = deVoice;
      u.rate = parseFloat($('#rate').value);
      u.pitch = parseFloat($('#pitch').value);
      u.volume = parseFloat($('#volume').value);
      u.onstart = () => status('Reproduciendo audio...', 'ok');
      u.onend = () => status('');
      u.onerror = () => status('Error al reproducir audio.', 'bad');
      speechSynthesis.speak(u);
    }
    // Speech Recognition
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = SpeechRecognition ? new SpeechRecognition() : null;
    if(recognition){
      recognition.continuous = false;
      recognition.interimResults = true;
      recognition.maxAlternatives = 1;
      recognition.onresult = (event) => {
        const transcript = Array.from(event.results)
          .map(r => r[0].transcript)
          .join('');
        guessEl.value = transcript;
        if(event.results[0].isFinal){
          status('');
          btnVoice.classList.remove('listening');
          btnVoice.disabled = false;
          check();
        }
      };
      recognition.onerror = (event) => {
        btnVoice.classList.remove('listening');
        btnVoice.disabled = false;
        if(event.error === 'not-allowed'){
          status('Permiso de micrÃ³fono denegado. HabilÃ­talo en la configuraciÃ³n del navegador.', 'bad');
        } else if(event.error === 'no-speech'){
          status('No se detectÃ³ voz. Habla mÃ¡s alto o revisa el micrÃ³fono.', 'bad');
        } else {
          status('Error en reconocimiento de voz: ' + event.error, 'bad');
        }
      };
      recognition.onend = () => {
        btnVoice.classList.remove('listening');
        btnVoice.disabled = false;
        if(guessEl.value){
          status('');
          check();
        }
      };
    }
    function startRecognition(){
      if(!recognition){
        status('Tu navegador no soporta reconocimiento de voz. Usa Chrome o Edge.', 'bad');
        return;
      }
      if(!window.location.protocol.includes('https') && window.location.hostname !== 'localhost'){
        status('El reconocimiento de voz requiere HTTPS o localhost.', 'bad');
        return;
      }
      recognition.lang = mode === 'de-to-es' ? 'es-ES' : 'de-DE';
      navigator.mediaDevices.getUserMedia({audio: true})
        .then(() => {
          btnVoice.classList.add('listening');
          recognition.start();
          status('Escuchando...', 'ok');
          btnVoice.disabled = true;
        })
        .catch(err => {
          if(err.name === 'NotAllowedError'){
            status('Permiso de micrÃ³fono denegado. HabilÃ­talo en la configuraciÃ³n del navegador.', 'bad');
          } else {
            status('Error al acceder al micrÃ³fono: ' + err.message, 'bad');
          }
        });
    }
    function norm(s){
      return String(s)
        .toLowerCase()
        .trim()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[!Â¡Â¿?.,;:]/g,'');
    }
    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }
    function status(msg, cls){
      statusEl.textContent = msg || '';
      statusEl.className = 'status' + (cls ? ' ' + cls : '');
    }
    function updateScore(){
      let currentScore = hits * CARD_VALUE - fails * FAIL_PENALTY;
      if(rondas > 1){
        const corrected = firstFails - wrongSet.size;
        const bonusPerCorrected = FAIL_PENALTY / (rondas - 1);
        currentScore += corrected * bonusPerCorrected;
      }
      score = Math.min(100, Math.max(0, currentScore));
      scoreEl.textContent = score.toFixed(1);
    }
    function updateCard(){
      if(queue.length === 0){
        status('No hay mÃ¡s fichas.', 'bad');
        return;
      }
      const item = queue[index];
      if(mode === 'de-to-es'){
        frontContent.innerHTML = `<div class="word">${item.de}</div>`;
        backContent.innerHTML = `<div class="meaning">${item.es[0]}</div>`;
        guessEl.placeholder = "Escribe o di el significado en espaÃ±olâ€¦";
      } else {
        frontContent.innerHTML = `<div class="meaning">${item.es[0]}</div>`;
        backContent.innerHTML = `<div class="word">${item.de}</div>`;
        guessEl.placeholder = "Escribe o di la palabra en alemÃ¡nâ€¦";
      }
      progressEl.textContent = `${index+1} / ${queue.length}`;
      guessEl.value = '';
      guessEl.disabled = false;
      guessEl.focus();
      status('');
      cardEl.classList.remove('flipped');
      $('#btnFlip').disabled = true;
      $('#btnFlipBack').disabled = true;  
    }
    function isCorrect(input, item){
      const gNorm = norm(input);
      const answers = (mode === 'de-to-es' ? item.es : [item.de]).map(norm);
      return answers.includes(gNorm);
    }
    function check(){
      if(!studentNameEl.value.trim() || !studentSurnameEl.value.trim()){
        status('Escribe tu nombre y apellido primero.', 'bad');
        studentNameEl.focus();
        return;
      }
      const item = queue[index];
      const g = guessEl.value;
      if(!g){ status('Escribe o di una respuesta primero.', 'bad'); return; }
      if(isCorrect(g, item)){
        hits++;
        hitsEl.textContent = hits;
        wrongSet.delete(item.de);
        status('Â¡Correcto! (+' + CARD_VALUE.toFixed(1) + ')', 'ok');
      }else{
        fails++;
        failsEl.textContent = fails;
        const wrongMsg = mode === 'de-to-es' 
          ? `No exactamente. Era: ${item.es[0]} (-${FAIL_PENALTY.toFixed(1)})`
          : `No exactamente. Era: ${item.de} (-${FAIL_PENALTY.toFixed(1)})`;
        status(wrongMsg, 'bad');
        wrongSet.add(item.de);
      }
      updateScore();
      flip();
      guessEl.disabled = true;
      $('#btnFlip').disabled = false; // AÃ±ade esta lÃ­nea
      $('#btnFlipBack').disabled = false; // AÃ±ade esta lÃ­nea
    }
    function next(){
  if(queue.length === 0){
    status('No hay mÃ¡s fichas.', 'bad');
    return;
  }
  if(!guessEl.value.trim() && !guessEl.disabled){
    const skippedCard = queue[index];
    queue.push(skippedCard);
  }
  index = (index + 1) % queue.length;
  if(index === 0 && !firstRoundCompleted && !onlyWrong){
    firstRoundCompleted = true;
    firstHits = hits;
    firstFails = fails;
    if(wrongSet.size > 0){
      onlyWrong = true;
      onlyWrongStateEl.textContent = 'on';
      rondas++;
      roundEl.textContent = rondas;
      rebuildQueue();
      status('Ronda completada. Ahora solo las falladas.', 'ok');
    } else {
      status('Â¡Todas correctas! Puedes finalizar o continuar practicando.', 'ok');
    }
  } else if(completedSet.size === TOTAL_CARDS && wrongSet.size > 0){
    onlyWrong = true;
    onlyWrongStateEl.textContent = 'on';
    rondas++;
    roundEl.textContent = rondas;
    completedSet.clear();
    rebuildQueue();
    status(`Ronda ${rondas - 1} completada. Continuando con las falladas.`, 'ok');
  } else if(completedSet.size === TOTAL_CARDS && wrongSet.size === 0){
    status('Â¡Todas correctas! Puedes finalizar o continuar practicando.', 'ok');
  }
  updateCard();
}
    function flip(){ cardEl.classList.toggle('flipped'); }
    function rebuildQueue(){
      if(onlyWrong){
        const wrong = DECK.filter(it => wrongSet.has(it.de));
        queue = wrong.length ? wrong : [...DECK];
      }else{
        queue = [...DECK];
      }
      index = 0;
      updateCard();
    }
    function saveResults(){
      if(!studentNameEl.value.trim() || !studentSurnameEl.value.trim()){
        status('Escribe tu nombre y apellido primero.', 'bad');
        studentNameEl.focus();
        return;
      }
      if(!queue.length && index !== 0){
     status('No hay mÃ¡s fichas para guardar.', 'bad');
     return;
    }
      const studentName = studentNameEl.value.trim();
      const studentSurname = studentSurnameEl.value.trim();
      const failedCards = Array.from(wrongSet).map(de => {
        const item = DECK.find(it => it.de === de);
        return `${item.de} (${item.es[0]})`;
      }).join(', ');
      const results = JSON.parse(localStorage.getItem('leaderboard') || '[]');
      results.push({
        name: studentName,
        surname: studentSurname,
        hits: TOTAL_CARDS - wrongSet.size,
        fails: wrongSet.size,
        score: score.toFixed(1),
        rondas,
        failedCards: failedCards || 'Ninguna'
      });
      localStorage.setItem('leaderboard', JSON.stringify(results));
      status('Resultados guardados. Pulsa "Ver ClasificaciÃ³n" para ver la tabla.', 'ok');
      rebuildQueue();
      firstRoundCompleted = false;
      rondas = 1;
      roundEl.textContent = rondas; // AÃ±ade esta lÃ­nea
      hits = 0; fails = 0; score = 0;
      firstHits = 0; firstFails = 0;
      hitsEl.textContent = hits;
      failsEl.textContent = fails;
      scoreEl.textContent = score;
      studentNameEl.value = '';
      studentSurnameEl.value = '';
      onlyWrong = false;
      onlyWrongStateEl.textContent = 'off';
      ({ CARD_VALUE, FAIL_PENALTY } = getScoringValues(mode)); // AÃ±ade esta lÃ­nea
    }
    function showLeaderboard(){
      const results = JSON.parse(localStorage.getItem('leaderboard') || '[]');
      results.sort((a, b) => a.surname.localeCompare(b.surname));
      leaderboardBodyEl.innerHTML = results.map(r => `
        <tr>
          <td>${r.surname}</td>
          <td>${r.name}</td>
          <td>${r.hits}</td>
          <td>${r.fails}</td>
          <td>${r.score}</td>
          <td>${r.rondas}</td>
          <td>${r.failedCards}</td>
        </tr>
      `).join('');
      leaderboardEl.style.display = 'block';
      btnShowLeaderboard.textContent = 'Ocultar ClasificaciÃ³n';
      btnShowLeaderboard.removeEventListener('click', showLeaderboard);
      btnShowLeaderboard.addEventListener('click', hideLeaderboard);
    }
    function hideLeaderboard(){
      leaderboardEl.style.display = 'none';
      btnShowLeaderboard.textContent = 'Ver ClasificaciÃ³n';
      btnShowLeaderboard.removeEventListener('click', hideLeaderboard);
      btnShowLeaderboard.addEventListener('click', showLeaderboard);
    }
    function copyResults(){
      const results = JSON.parse(localStorage.getItem('leaderboard') || '[]');
      results.sort((a, b) => a.surname.localeCompare(b.surname));
      const text = results.map(r => `${r.surname}\t${r.name}\t${r.hits}\t${r.fails}\t${r.score}\t${r.rondas}\t${r.failedCards}`).join('\n');
      navigator.clipboard.writeText(`Apellido\tNombre\tAciertos\tFallos\tPuntuaciÃ³n\tRondas\tFichas Falladas\n${text}`)
        .then(() => status('Resultados copiados al portapapeles.', 'ok'))
        .catch(() => status('Error al copiar resultados.', 'bad'));
    }
    // === Eventos ===
    $('#btnPlay').addEventListener('click', () => speak(queue[index].de));
    $('#btnPlayBack').addEventListener('click', () => speak(queue[index].de));
    $('#btnFlip').addEventListener('click', flip);
    $('#btnFlipBack').addEventListener('click', flip);
    $('#btnCheck').addEventListener('click', check);
    $('#btnNext').addEventListener('click', next);
    $('#btnShuffle').addEventListener('click', () => { shuffle(queue); rebuildQueue(); });
    $('#btnOnlyWrong').addEventListener('click', () => {
    if(firstRoundCompleted && onlyWrong){
        status('No puedes desactivar "Solo falladas" despuÃ©s de la primera ronda.', 'bad');
        return;
     }
     onlyWrong = !onlyWrong;
    if(onlyWrong){
        rondas++;
        roundEl.textContent = rondas; // AÃ±ade esta lÃ­nea
      }
      onlyWrongStateEl.textContent = onlyWrong ? 'on' : 'off';
      rebuildQueue();
    });
    $('#btnToggleMode').addEventListener('click', () => {
        mode = mode === 'de-to-es' ? 'es-to-de' : 'de-to-es';
        btnToggleMode.textContent = mode === 'de-to-es' ? 'Cambiar a EspaÃ±ol a AlemÃ¡n' : 'Cambiar a AlemÃ¡n a EspaÃ±ol';
        ({ CARD_VALUE, FAIL_PENALTY } = getScoringValues(mode)); // Actualiza puntuaciones
        updateScore(); // Recalcula el puntaje actual
        next();
    });
    $('#btnVoice').addEventListener('click', startRecognition);
    $('#btnSaveResults').addEventListener('click', saveResults);
    $('#btnShowLeaderboard').addEventListener('click', showLeaderboard);
    $('#btnCopyResults').addEventListener('click', copyResults);
    // Accesos rÃ¡pidos
    window.addEventListener('keydown', (e) => {
      if(e.target === guessEl || e.target === studentNameEl || e.target === studentSurnameEl){
        if(e.key === 'Enter' && e.target === guessEl){check();}
        return;
      }
      if(e.code === 'Space'){
        e.preventDefault();
        speak(queue[index].de);
      }
      if(e.key.toLowerCase() === 'n'){ next(); }
      if(e.key.toLowerCase() === 'f'){ flip(); }
      if(e.key.toLowerCase() === 'v'){ startRecognition(); }
    });
    // Cargar voces
    if('speechSynthesis' in window){
      let voicesLoaded = false;
      const loadVoices = () => {
        if(voicesLoaded) return;
        const voices = speechSynthesis.getVoices();
        if(voices.length) voicesLoaded = true;
      };
      speechSynthesis.onvoiceschanged = loadVoices;
      loadVoices();
    }
    // Init
    shuffle(queue);
    roundEl.textContent = rondas; // AÃ±ade esta lÃ­nea
    updateCard();
    studentNameEl.focus();
  </script>
</body>
</html>
